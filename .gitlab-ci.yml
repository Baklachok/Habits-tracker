image: python:3.12

services:
  - name: mysql:8
    alias: db

variables:
  MYSQL_ROOT_PASSWORD: root
  MYSQL_DATABASE: test_db
  MYSQL_USER: test
  MYSQL_PASSWORD: test

  # Чтобы SQLAlchemy подключался
  DATABASE_URL: "mysql+pymysql://test:test@db:3306/test_db"

  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"

cache:
  paths:
    - .venv/
    - ~/.cache/pypoetry/

before_script:
  - pip install --no-cache-dir poetry
  - poetry install --no-interaction --no-ansi

  # MySQL client for migration/test scripts
  - apt-get update && apt-get install -y default-mysql-client

  # Wait for MySQL
  - |
    echo "Waiting for MySQL to be ready..."
    until mysqladmin ping -h db --silent; do
      echo "MySQL is unavailable - sleeping"
      sleep 2
    done
  - echo "MySQL is UP"

stages:
  - lint
  - typing
  - test

lint:
  stage: lint
  script:
    - poetry run ruff check .
  tags: []

mypy:
  stage: typing
  script:
    - poetry run mypy .
  tags: []

pytest:
  stage: test
  script:
    # optional — если есть миграции
    - if [ -d "migrations" ]; then poetry run alembic upgrade head; fi

    - poetry run pytest -q
  tags: []
